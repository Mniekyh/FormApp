<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <title>Panel uÅ¼ytkownika</title>
    <!-- <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        
        .sprawa {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .ticket {
            background: #f4f4f4;
            padding: 10px;
            margin-top: 10px;
        }
        
        .zalaczniki img {
            max-width: 150px;
            max-height: 150px;
            display: block;
            margin-bottom: 5px;
        }
        
        .zalacznik-link {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }
    </style> -->
    <link href="/style.css" rel="stylesheet">


</head>

<body>
    <h1>Witaj,
        <%= user.imie %>
            <%= user.id %>
                <%= user.nazwisko %>!</h1>
    <form action="/logout" method="POST">
        <button type="submit" class="btn">Wyloguj</button>
    </form>
    <% if (user && user.rola === 'agent') { %>
        <a href="/panel-agent" class="btn-link">Panel Agenta</a>
        <% } %>


            <h2>Twoje sprawy</h2>

            <% if (user.rola === 'ubezpieczony') { %>
                <form action="/zgloszenie" method="POST">
                    <h3>Nowe zgÅ‚oszenie</h3>
                    <input type="text" name="Imie" placeholder="ImiÄ™" required>
                    <input type="text" name="Nazwisko" placeholder="Nazwisko" required>
                    <input type="text" name="Adres" placeholder="Adres" required>
                    <input type="text" name="Telefon" placeholder="Telefon" required>
                    <input type="email" name="Mail" placeholder="Email" required>
                    <textarea name="Opis" placeholder="Opis zgÅ‚oszenia" required></textarea>
                    <button type="submit" class="btn">ZgÅ‚oÅ›</button>
                </form>
                <% } %>

                    <% sprawy.forEach(sprawa => { %>
                        <div class="sprawa">
                            <h3>Sprawa ID:
                                <%= sprawa.Id_sprawa %>
                            </h3>
                            <p><strong>ImiÄ™ i nazwisko:</strong>
                                <%= sprawa.Imie %>
                                    <%= sprawa.Nazwisko %>
                            </p>
                            <p><strong>Status:</strong>
                                <%= sprawa.Stan %>
                            </p>
                            <p><strong>Opis:</strong>
                                <%= sprawa.Opis %>
                            </p>

                            <% if (sprawa.tickets && sprawa.tickets.length) { %>
                                <h4>Historia:</h4>
                                <% sprawa.tickets.forEach(ticket => { %>
                                    <div class="ticket">
                                        <strong><%= ticket.Autor %></strong> [
                                        <%= ticket.Data %>]:
                                            <%= ticket.Tresc %>
                                                <% if (ticket.Typ) { %><em>(<%= ticket.Typ %>)</em>
                                                    <% } %>
                                    </div>
                                    <% }) %>
                                        <% } %>

                                            <% if (user.rola === 'ubezpieczyciel' ) { %>
                                                <form action="/sprawa/<%= sprawa.Id_sprawa %>/ticket" method="POST">
                                                    <textarea name="Tresc" placeholder="Dodaj notatkÄ™..." required></textarea>
                                                    <button type="submit" class="btn">Dodaj ticket</button>
                                                </form>

                                                <form action="/sprawa/edytuj/<%= sprawa.Id_sprawa %>" method="POST">
                                                    <h4>Edycja sprawy</h4>
                                                    <input type="text" name="Imie" value="<%= sprawa.Imie %>" required>
                                                    <input type="text" name="Nazwisko" value="<%= sprawa.Nazwisko %>" required>
                                                    <input type="text" name="Id_kategoria" placeholder="Kategoria (ID)" value="<%= sprawa.Id_kategoria %>">
                                                    <input type="text" name="Adres" value="<%= sprawa.Adres %>" required>
                                                    <input type="text" name="Telefon" value="<%= sprawa.Telefon %>" required>
                                                    <input type="email" name="Mail" value="<%= sprawa.Mail %>" required>
                                                    <textarea name="Opis"><%= sprawa.Opis %></textarea>
                                                    <input type="text" name="Stan" value="<%= sprawa.Stan %>" required>
                                                    <input type="text" name="Id_agent" placeholder="Agent (ID)" value="<%= sprawa.Id_agent %>">
                                                    <button type="submit" class="btn">Zapisz zmiany</button>
                                                </form>

                                                <form action="/sprawa/usun/<%= sprawa.Id_sprawa %>" method="POST">
                                                    <button type="submit" class="btn" onclick="return confirm('Na pewno chcesz usunÄ…Ä‡ sprawÄ™?')">UsuÅ„ sprawÄ™</button>
                                                </form>

                                                <form action="/sprawa/<%= sprawa.Id_sprawa %>/upload" method="POST" enctype="multipart/form-data">
                                                    <input type="file" name="zalacznik" required>
                                                    <button type="submit" class="btn">WyÅ›lij zaÅ‚Ä…cznik</button>
                                                </form>
                                                <% } %>

                                                    <% if (Array.isArray(sprawa.zalaczniki) && sprawa.zalaczniki.length > 0) { %>


                                                        <div class="zalaczniki">
                                                            <h4>ZaÅ‚Ä…czniki:</h4>
                                                            <ul>
                                                                <% sprawa.zalaczniki.forEach(z => { %>
                                                                    <li class="zalacznik-link">
                                                                        <% if (z && z.nazwa_pliku && z.nazwa_pliku.match(/\.(jpg|jpeg|png|gif)$/i)) { %>


                                                                            <img src="/uploads/<%= z.Nazwa_pliku %>" alt="obraz">
                                                                            <% } else if (z && z.Nazwa_pliku && z.Nazwa_pliku.match(/\.(pdf)$/i)) { %>
                                                                                <img src="/uploads/<%= z.Nazwa_pliku %>" /> ðŸ“„ <a href="/uploads/<%= z.Nazwa_pliku %>" target="_blank">PDF: <%= z.Nazwa_pliku %></a>
                                                                                <% } else { %>
                                                                                    ðŸ“Ž
                                                                                    <a href="/uploads/<%= z.Nazwa_pliku %>" target="_blank">
                                                                                <img src="/uploads/<%= z.Nazwa_pliku %>"/>
                                                                                <%= z.Nazwa_pliku %>
                                                                            </a>
                                                                                    <% } %>
                                                                                        <form method="POST" action="/zalacznik/usun/<%= z.Id_zalacznik %>" style="display:inline;">
                                                                                            <button type="submit" class="btn">ðŸ—‘ UsuÅ„</button>
                                                                                        </form>
                                                                    </li>
                                                                    <% }) %>
                                                            </ul>
                                                        </div>
                                                        <% } %>
                        </div>
                        <% }) %>
</body>

</html>